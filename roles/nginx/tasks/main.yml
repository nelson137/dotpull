- become: true
  vars:
    le_dir: /opt/letsencrypt
  block:

    - name: Install (Debian)
      when: ansible_os_family == "Debian"
      apt: name=nginx state=latest

    - when: ansible_os_family == "RedHat"
      block:

        - name: Install (Amazon)
          when: ansible_distribution == "Amazon"
          command:
            cmd: amazon-linux-extras install -y nginx1=latest
            creates: /usr/sbin/nginx

        - name: Install (RedHat)
          when: ansible_distribution != "Amazon"
          yum: name=nginx state=latest

    - name: Install config
      copy:
        src: nginx.conf
        dest: /etc/nginx/nginx.conf
        checksum: 155013005720e719b6d8f13be737fe6430e7af34
      notify: reload nginx

    - name: Generate Diffie-Hellman parameters
      openssl_dhparam: size=4096 path=/etc/ssl/certs/dhparam.pem

    # Delete HTTP Strict Transport Security headers cache on Chrome
    # [here](chrome://net-internals/#hsts)
    - name: Install SSL config
      template: src=ssl.conf.j2 dest=/etc/nginx/ssl.conf
      notify: reload nginx

    - name: Enable service
      systemd: name=nginx enabled=true state=started

    - name: Create Lets Encrypt working directory
      file: path='{{ le_dir }}' state=directory

    - name: Create Lets Encrypt webroot directory
      file: path='/usr/share/nginx/letsencrypt' state=directory

    - name: Install Lets Encrypt command script
      template: src=le-cmd dest='{{ le_dir }}/le-cmd' mode=0775

    - name: Install dependencies for ansible docker modules
      pip:
        name:
          - docker

    - name: Check if Lets Encrypt certificate already exists
      stat: path='/etc/letsencrypt/live/{{ domain_name }}' get_checksum=false get_mime=false
      register: le_cert

    - when: le_cert.stat.exists == false
      block:

        # Get the current certificate issuer, issue date, and expiration date,
        # (the issuer for the test cert will be prefixed with "(STAGING)"):
        #
        #   $ curl -sSkIvv https://nelsonearle.com 2>&1 | sed -nE '/\* Server certificate:/{:loop;p;n;/^\*  /b loop;q}'
        #
        - name: Get test certificate from Lets Encrypt
          command:
            cmd: '{{ le_dir }}/le-cmd cert-get --staging'
            creates: '/etc/letsencrypt/live/{{ domain_name }}'

        - name: Revoke and delete test certificate
          command:
            cmd: '{{ le_dir }}/le-cmd cert-revoke --staging'
            removes: '/etc/letsencrypt/live/{{ domain_name }}'

        - name: Get certificate from Lets Encrypt
          command:
            cmd: '{{ le_dir }}/le-cmd cert-get'
            creates: '/etc/letsencrypt/live/{{ domain_name }}'

    - name: Install cron job to renew the Lets Encrypt certificate
      cron:
        name: renew Lets Encrypt certificate
        user: root
        minute: '0'
        hour: '23'
        job: '{{ le_dir }}/le-cmd cert-renew'
