- name: Check if already installed
  stat: path='{{ ansible_user_dir }}/.oh-my-zsh' get_checksum=false get_mime=false
  register: omz_dir

- name: Oh My Zsh
  when: omz_dir.stat.exists == false
  vars:
    omz_installer_path: /tmp/install-ohmyzsh
  block:

    - name: Download installer
      get_url:
        url: https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh
        dest: '{{ omz_installer_path }}'
        mode: '0755'

    - name: Execute installer
      command:
        cmd: '{{ omz_installer_path }} --unattended'
        creates: '{{ ansible_user_dir }}/.oh-my-zsh'

    - name: Remove installer
      file: path='{{ omz_installer_path }}' state=absent

- name: Change user shell to zsh
  become: true
  user: name='{{ ansible_user_id }}' shell=/usr/bin/zsh
